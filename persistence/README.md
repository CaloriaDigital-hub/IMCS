# Модуль ersistence

Модуль `persistence` предназначен для обеспечения долговременного хранения данных и команд в системе IMCS.

## Структура

- **AOF/** — реализация append-only file (журнала команд):
  - `read.go` — чтение команд из журнала.
  - `write.go` — запись команд в журнал.
  - `types.go` — основные типы для работы с журналом.
  - `README.md` — описание формата и принципов работы.
- **format.go** — описание формата хранения данных.

### Формат журнала команд (AOF)

Каждая строка файла журнала имеет вид:

```Struc
<cmd>|<key>|<expire>|<value>
```

- `cmd` — команда (например, set, del, get)
- `key` — ключ
- `expire` — время истечения (UnixNano, 0 если бессрочно)
- `value` — значение

### Принципы работы

- Все операции записи и чтения потокобезопасны (используется мьютекс).
- При чтении некорректные строки пропускаются.
- Для каждой корректной строки вызывается обработчик.

### Использование

1. Для создания экземпляра AOF используйте функцию `NewAOF(dir string)`.
2. Для записи используйте метод `Write(input WriteInput)`.
3. Для чтения используйте метод `Read(rf func(cmd, key, value string, expire int64))`.
4. Для закрытия файла используйте метод `Close()`.

### Пример

```go
aof, err := AOF.NewAOF("cache-files")
if err != nil { /* обработка ошибки */ }

input := AOF.WriteInput{Cmd: "set", Key: "foo", Value: "bar", TTL: time.Second * 60,
}
aof.Write(input)

aof.Read(func(cmd, key, value string, expire int64) {
// обработка команды
})

aof.Close()
```

---
Для подробностей см. комментарии в исходных файлах.
